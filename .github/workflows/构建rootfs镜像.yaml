name: 构建系统镜像

on:
  workflow_dispatch:
    inputs:
      system_type:
        description: '系统类型'
        required: true
        default: 'kali-desktop'
        type: choice
        options:
          - kali-desktop
          - kali-server
          - kali-nethunter
      
      kernel_version:
        description: '内核版本号（如 6.12）'
        required: true
        type: string
      
      desktop_env:
        description: '桌面环境（仅桌面版有效）'
        required: false
        default: 'xfce-full'
        type: choice
        options:
          - xfce-full
          - xfce-minimal
          - none

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap parted e2fsprogs xz-utils
      
      - name: 下载内核包
        run: |
          mkdir -p debs
          cd debs
          
          echo "下载内核包..."
          
          # 你的固定下载地址
          wget -q --show-progress "https://github.com/yalei16/linux-xiaomi-raphael-uefi/releases/download/kernel-v6.18/linux-image-xiaomi-raphael.deb"
          wget -q --show-progress "https://github.com/yalei16/linux-xiaomi-raphael-uefi/releases/download/kernel-v6.18/linux-headers-xiaomi-raphael.deb"
          wget -q --show-progress "https://github.com/yalei16/linux-xiaomi-raphael-uefi/releases/download/kernel-v6.18/firmware-xiaomi-raphael.deb"
          wget -q --show-progress "https://github.com/yalei16/linux-xiaomi-raphael-uefi/releases/download/kernel-v6.18/alsa-xiaomi-raphael.deb"
          
          echo "下载完成:"
          ls -la *.deb
          
          # 验证
          if [[ ! -f "linux-image-xiaomi-raphael.deb" ]]; then
            echo "错误: 内核包下载失败"
            exit 1
          fi
      
      - name: 构建系统镜像
        run: |
          SYSTEM_TYPE="${{ github.event.inputs.system_type }}"
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"
          ROOTFS_IMG="rootfs-${SYSTEM_TYPE}-${KERNEL_VER}.img"
          
          echo "构建: $SYSTEM_TYPE"
          echo "内核: $KERNEL_VER"
          echo "输出: $ROOTFS_IMG"
          
          truncate -s 10G "$ROOTFS_IMG"
          mkfs.ext4 -F -L "linux" "$ROOTFS_IMG"
          
          mkdir -p rootfs
          sudo mount -o loop "$ROOTFS_IMG" rootfs
      
      - name: 安装Kali基础系统
        run: |
          echo ">>> 构建 Kali Linux"
          sudo debootstrap --foreign --arch=arm64 kali-rolling rootfs http://mirrors.tuna.tsinghua.edu.cn/kali
          
          sudo chroot rootfs /debootstrap/debootstrap --second-stage
          
          echo "deb http://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free non-free-firmware" | sudo tee rootfs/etc/apt/sources.list
          echo "kali-raphael" | sudo tee rootfs/etc/hostname
          echo "127.0.0.1 localhost" | sudo tee rootfs/etc/hosts
          echo "127.0.1.1 kali-raphael" | sudo tee -a rootfs/etc/hosts
      
      - name: 配置系统
        run: |
          sudo mount --bind /dev rootfs/dev
          sudo mount --bind /proc rootfs/proc
          sudo mount --bind /sys rootfs/sys
          
          sudo chroot rootfs apt-get update
          sudo chroot rootfs apt-get upgrade -y
      
      - name: 安装软件包
        run: |
          SYSTEM_TYPE="${{ github.event.inputs.system_type }}"
          DESKTOP_ENV="${{ github.event.inputs.desktop_env }}"
          
          sudo chroot rootfs apt-get install -y \
            sudo ssh openssh-server \
            initramfs-tools curl wget \
            net-tools wireless-tools wpasupplicant \
            vim nano
      
          if [[ "$SYSTEM_TYPE" == "kali-desktop" ]]; then
            if [[ "$DESKTOP_ENV" == "xfce-full" ]]; then
              sudo chroot rootfs apt-get install -y \
                xfce4 xfce4-goodies lightdm slick-greeter \
                xorg dbus-x11 onboard
              sudo chroot rootfs systemctl enable lightdm
            elif [[ "$DESKTOP_ENV" == "xfce-minimal" ]]; then
              sudo chroot rootfs apt-get install -y \
                xfce4 lightdm onboard
              sudo chroot rootfs systemctl enable lightdm
            fi
            sudo chroot rootfs apt-get install -y nmap netcat-traditional || true
            
          elif [[ "$SYSTEM_TYPE" == "kali-nethunter" ]]; then
            sudo chroot rootfs apt-get install -y xfce4 lightdm onboard
            sudo chroot rootfs systemctl enable lightdm
          fi
          
          # 修复：设置图形界面为默认启动（添加）
          sudo chroot rootfs systemctl set-default graphical.target
          
          # 修复：配置自动登录（添加）
          sudo mkdir -p rootfs/etc/lightdm
          echo "[Seat:*]" | sudo tee rootfs/etc/lightdm/lightdm.conf
          echo "autologin-user=kali" | sudo tee -a rootfs/etc/lightdm/lightdm.conf
          echo "autologin-user-timeout=0" | sudo tee -a rootfs/etc/lightdm/lightdm.conf
          echo "user-session=xfce" | sudo tee -a rootfs/etc/lightdm/lightdm.conf
          
          # 用户配置
          echo "root:kali" | sudo chroot rootfs chpasswd
          sudo chroot rootfs useradd -m -G sudo -s /bin/bash kali 2>/dev/null || true
          echo "kali:kali" | sudo chroot rootfs chpasswd
          
          # SSH配置
          echo "PermitRootLogin yes" | sudo tee -a rootfs/etc/ssh/sshd_config
          echo "PasswordAuthentication yes" | sudo tee -a rootfs/etc/ssh/sshd_config
      
      - name: 安装内核
        run: |
          sudo cp debs/*.deb rootfs/tmp/ 2>/dev/null || {
            echo "错误: 未找到内核deb包"
            exit 1
          }
          
          echo ">>> 安装内核"
          sudo chroot rootfs apt-get update
          sudo chroot rootfs apt-get clean
          
          sudo chroot rootfs bash -c "
            cd /tmp
            dpkg -i *.deb 2>/dev/null || true
            apt-get install -f -y
            dpkg --configure -a 2>/dev/null || true
          "
          
          KERNEL_DIR=$(ls rootfs/lib/modules/ | head -1)
          if [[ -n "$KERNEL_DIR" ]]; then
            sudo chroot rootfs update-initramfs -c -k "$KERNEL_DIR" 2>/dev/null || true
          fi
          
          sudo chroot rootfs bash -c '
            cd /boot
            KERNEL=$(ls vmlinuz-* 2>/dev/null | head -1)
            INITRD=$(ls initrd.img-* 2>/dev/null | head -1)
            [ -n "$KERNEL" ] && ln -sf "$KERNEL" vmlinuz
            [ -n "$INITRD" ] && ln -sf "$INITRD" initrd.img
            ls -la
          '
      
      - name: 配置引导
        run: |
          sudo chroot rootfs apt-get install -y grub-efi-arm64 2>/dev/null || true
          
          echo "PARTLABEL=linux / ext4 errors=remount-ro 0 1" | sudo tee rootfs/etc/fstab
          echo "PARTLABEL=esp /boot/efi vfat umask=0077 0 1" | sudo tee -a rootfs/etc/fstab
          
          sudo mkdir -p rootfs/boot/efi
      
      - name: 清理和压缩
        run: |
          sudo chroot rootfs apt-get clean 2>/dev/null || true
          sudo rm -rf rootfs/var/lib/apt/lists/* rootfs/tmp/* 2>/dev/null || true
          
          sudo umount rootfs/dev 2>/dev/null || true
          sudo umount rootfs/proc 2>/dev/null || true
          sudo umount rootfs/sys 2>/dev/null || true
          sudo umount rootfs 2>/dev/null || true
          
          ROOTFS_IMG="rootfs-${{ github.event.inputs.system_type }}-${{ github.event.inputs.kernel_version }}.img"
          xz -T0 -v "$ROOTFS_IMG"
      
      - name: 发布
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kali-${{ github.event.inputs.system_type }}-${{ github.event.inputs.kernel_version }}
          name: "Kali ${{ github.event.inputs.system_type }} ${{ github.event.inputs.kernel_version }}"
          files: rootfs-*.img.xz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
