name: 内核编译

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: '内核版本号（如 6.12）'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 安装编译依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential crossbuild-essential-arm64 \
            libncurses-dev bison flex libssl-dev \
            bc git wget device-tree-compiler
      
      - name: 下载内核源码
        run: |
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"
          wget "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${KERNEL_VER}.tar.xz"
          tar -xf "linux-${KERNEL_VER}.tar.xz"
      
      - name: 配置和编译
        run: |
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"
          cd "linux-${KERNEL_VER}"
          
          # 使用Raphael配置
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- raphael_defconfig
          
          # 启用必要选项
          ./scripts/config --enable CONFIG_EFI
          ./scripts/config --enable CONFIG_EFI_STUB
          
          # 编译
          make -j$(nproc) ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-
          
          # 打包deb
          make -j$(nproc) ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- deb-pkg
      
      - name: 发布内核
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "kernel-${{ github.event.inputs.kernel_version }}"
          name: "Kernel ${{ github.event.inputs.kernel_version }} for Raphael"
          files: |
            ../*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
